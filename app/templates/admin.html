<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Traffic Violations</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .badge-triple-riding {
            background-color: #ff8c00 !important;
            color: #000 !important;
        }
        .badge-no-helmet {
            background-color: #dc3545 !important;
            color: #fff !important;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="text-primary"><i class="bi bi-shield-exclamation"></i> Admin Dashboard</h1>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Home
                    </a>
                </div>

                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0">
                                <i class="bi bi-table"></i> Traffic Violations Database
                                <span class="badge bg-light text-dark ms-2">{{ violations|length }} Total Records</span>
                            </h3>
                            {% if violations %}
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('export_csv') }}" class="btn btn-success">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                                <button class="btn btn-danger" onclick="deleteAllViolations()">
                                    <i class="bi bi-trash"></i> Remove All
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body p-0">
                        {% if violations %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Date & Time</th>
                                        <th scope="col">Violation Type</th>
                                        <th scope="col">Fine Amount</th>
                                        <th scope="col">Number Plate</th>
                                        <th scope="col">Evidence</th>
                                        <th scope="col">View</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for violation in violations %}
                                    <tr id="violation-row-{{ violation.id }}">
                                        <td><strong>{{ violation.id }}</strong></td>
                                        <td>
                                            <small class="text-muted">
                                                {{ violation.ts_utc[:19].replace('T', ' ') }} UTC
                                            </small>
                                        </td>
                                        <td>
                                            {% if violation.violation_type|lower == 'triple riding' %}
                                            <span class="badge badge-triple-riding">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                {{ violation.violation_type }}
                                            </span>
                                            {% else %}
                                            <span class="badge badge-no-helmet">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                {{ violation.violation_type }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong class="text-success">₹{{ violation.fine }}</strong>
                                        </td>
                                        <td>
                                            <div class="input-group input-group-sm">
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="plate_{{ violation.id }}" 
                                                       value="{{ violation.number_plate or '' }}" 
                                                       placeholder="Enter plate number"
                                                       maxlength="20">
                                                <button class="btn btn-outline-success" 
                                                        type="button" 
                                                        onclick="saveNumberPlate({{ violation.id }})">
                                                    <i class="bi bi-check"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ violation.file_path.split('/')[-1] if '/' in violation.file_path else violation.file_path.split('\\')[-1] }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if violation.file_path %}
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="viewImage('{{ violation.file_path }}', '{{ violation.violation_type }}')">
                                                <i class="bi bi-eye"></i> View
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <h3 class="text-muted mt-3">No Violations Found</h3>
                            <p class="text-muted">No traffic violations have been detected yet.</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="bi bi-camera-video"></i> Start Detection
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if violations %}
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <h5><i class="bi bi-exclamation-triangle"></i> Total Violations</h5>
                                <h2>{{ violations|length }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5><i class="bi bi-currency-rupee"></i> Total Fines</h5>
                                <h2>₹{{ violations|sum(attribute='fine') }}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5><i class="bi bi-calendar-event"></i> Latest Detection</h5>
                                <p class="mb-0">
                                    {% if violations %}
                                    {{ violations[0].ts_utc[:10] }}
                                    {% else %}
                                    No data
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h5><i class="bi bi-shield-x"></i> Most Common</h5>
                                <p class="mb-0">No helmet</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for viewing images -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Evidence Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="evidenceImage" src="" class="img-fluid" alt="Evidence">
                    <p class="mt-2 text-muted" id="imagePath"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function viewImage(filePath, violationType) {
            // Use the new /image/ endpoint for serving images
            const imageUrl = '/image/' + filePath;
            
            document.getElementById('evidenceImage').src = imageUrl;
            document.getElementById('imagePath').textContent = filePath;
            document.getElementById('imageModalLabel').textContent = 'Evidence: ' + violationType;
            
            // Add error handling for image loading
            const img = document.getElementById('evidenceImage');
            img.onerror = function() {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBOb3QgRm91bmQ8L3RleHQ+PC9zdmc+';
                console.error('Failed to load image:', filePath);
            };
            
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        function saveNumberPlate(violationId) {
            const input = document.getElementById('plate_' + violationId);
            const numberPlate = input.value.trim();
            
            // Show loading state
            const button = input.nextElementSibling;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            button.disabled = true;
            
            fetch('/update_number_plate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    violation_id: violationId,
                    number_plate: numberPlate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success feedback
                    button.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.disabled = false;
                    }, 1500);
                } else {
                    alert('Error: ' + data.message);
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to save number plate');
                button.innerHTML = originalContent;
                button.disabled = false;
            });
        }

        function deleteAllViolations() {
            if (!confirm('Are you sure you want to delete ALL violation records? This action cannot be undone and will remove all data from the database.')) {
                return;
            }

            // Show loading state
            const button = event.target;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
            button.disabled = true;

            fetch('/delete_all_violations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload the page to show empty state
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete all violations');
                button.innerHTML = originalContent;
                button.disabled = false;
            });
        }
    </script>
</body>
</html>
